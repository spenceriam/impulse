# AGENTS.md

> Auto-generated by glm-cli. This is the project brain.

## Project Overview

**glm-cli** is a terminal-based AI coding agent powered by Zhipu AI's GLM-4.x models. It provides a brutally minimal, flicker-free terminal UI for interactive AI-assisted software development.

### Identity

- **Name:** glm-cli
- **Version:** v0.1.0
- **Tagline:** AI coding agent powered by GLM-4.7
- **Design:** Brutally minimal
- **License:** MIT

## Current State

**Status:** Pre-development (Documentation Phase)

The project is currently in the planning and documentation phase. No source code has been written yet. This documentation serves as the blueprint for implementation.

## Tech Stack

| Category | Technology |
|----------|------------|
| **Runtime** | Bun / Node.js 20+ |
| **Language** | TypeScript (strict mode) |
| **UI Framework** | OpenTUI with SolidJS reconciler |
| **API** | Z.AI API (OpenAI-compatible) |
| **Endpoint** | `https://api.z.ai/api/coding/paas/v4/` |

### Dependencies (Planned)

- `@opentui/core` - Core TUI rendering engine
- `@opentui/solid` - SolidJS bindings for OpenTUI
- `solid-js` - Reactive UI framework
- `openai` - OpenAI-compatible SDK for Z.AI API
- `zod` - Runtime type validation

## Models Supported

| Model | Type | Best For |
|-------|------|----------|
| `glm-4.7` | Text | Flagship - complex coding, reasoning (default) |
| `glm-4.7-flash` | Text | Fast flagship variant |
| `glm-4.6` | Text | Previous gen flagship |
| `glm-4.6v` | Vision | Image understanding |
| `glm-4.5` | Text | Efficient general model |
| `glm-4.5-air` | Text | Lightweight, fast |
| `glm-4.5-flash` | Text | Ultra-fast |
| `glm-4.5v` | Vision | Quick image tasks |

## Modes

| Mode | Color | Purpose | Tools |
|------|-------|---------|-------|
| **AUTO** | White `#ffffff` | AI decides based on prompt | Switches dynamically |
| **AGENT** | Cyan `#5cffff` | Full execution + looper skill | All tools |
| **PLANNER** | Purple `#b48eff` | Research + documentation | Read-only + docs/ |
| **PLAN-PRD** | Blue `#5c8fff` | Quick PRD via Q&A | Read-only + docs/ |
| **DEBUG** | Orange `#ffaa5c` | 7-step systematic debugging | All tools |

## Agents

| Agent | Mode | Tools | Purpose |
|-------|------|-------|---------|
| `build` | Primary | All | Main coding agent |
| `explore` | Subagent | Read-only (grep, glob, read) | Fast codebase search |
| `general` | Subagent | Most (no todo) | Complex multi-step tasks |

Agent-controlled delegation (no @ syntax for users).

## Todo System

Session-scoped task management for tracking complex, multi-step work.

### Data Model

```typescript
interface Todo {
  id: string        // Unique identifier
  content: string   // Brief task description
  status: string    // pending | in_progress | completed | cancelled
  priority: string  // high | medium | low
}
```

### Tools

| Tool | Purpose |
|------|---------|
| `TodoWrite` | Replace entire todo list (full replacement) |
| `TodoRead` | Read current session todos |

### UI Display

Todos appear in the sidebar panel:
- `[ ]` = pending (muted)
- `[>]` = in_progress (cyan)
- `[x]` = completed (muted)

Section collapses when >2 items, hides when all completed.

### Agent Usage

- Use for tasks with 3+ steps
- Only ONE todo `in_progress` at a time
- Mark complete IMMEDIATELY after finishing
- Don't use for trivial single-step tasks

## MCP Servers

All 4 Z.AI MCP servers use a single API key:

| Server | Type | Tools |
|--------|------|-------|
| **Vision** | Local (stdio) | `ui_to_artifact`, `extract_text_from_screenshot`, `diagnose_error_screenshot`, `understand_technical_diagram`, `analyze_data_visualization`, `ui_diff_check`, `image_analysis`, `video_analysis` |
| **Web Search** | Remote (HTTP) | `webSearchPrime` |
| **Web Reader** | Remote (HTTP) | `webReader` |
| **Zread** | Remote (HTTP) | `search_doc`, `get_repo_structure`, `read_file` |

## Commands

| Command | Description |
|---------|-------------|
| `/new` | New session (prompt to save) |
| `/compact` | Manual AI summarization |
| `/save` | Save with AI-suggested name |
| `/load` | Session picker with preview |
| `/undo` | Git-based revert to checkpoint |
| `/redo` | Restore undone changes |
| `/model` | Switch GLM model |
| `/mode` | Switch mode (alt to Tab) |
| `/instruct` | Edit project instructions |
| `/config` | Basic settings overlay |
| `/stats` | Session statistics |
| `/help` | Categorized help overlay |
| `/think` | Toggle thinking mode |
| `/quit` | Exit with summary |
| `/exit` | Exit with summary |

## Keyboard Shortcuts

| Key | Action |
|-----|--------|
| `Tab` | Cycle modes |
| `Shift+Tab` | Cycle modes reverse |
| `Enter` | Submit / Select |
| `Shift+Enter` | Line break in input |
| `↑/↓` | Navigate / Scroll |
| `@` | File/directory autocomplete |
| `Esc` (2x) | Cancel / Stop operation |
| `Ctrl+C` (2x) | Exit with summary |
| `Ctrl+M` | MCP status overlay |
| `Ctrl+P` | Command palette |

## Project Conventions

### Code Style
- TypeScript strict mode
- No `any` types
- Prefer functional components
- Use Zod for runtime validation

### Naming
- Files: kebab-case (`status-line.tsx`)
- Components: PascalCase (`StatusLine`)
- Functions: camelCase (`createSession`)
- Constants: UPPER_SNAKE_CASE (`MAX_RETRIES`)

### Commits
- Conventional commits format
- Commit after each discrete task
- No `git push` without explicit permission

### UI
- No emojis anywhere
- Brutalist aesthetic
- 16ms event batching for streaming
- 60fps target

## Generated Documentation

| Document | Purpose | Generated |
|----------|---------|-----------|
| [docs/Requirements.md](docs/Requirements.md) | Functional and non-functional requirements | 01-19-2026 |
| [docs/Design.md](docs/Design.md) | Architecture and system design | 01-19-2026 |
| [docs/Tasks.md](docs/Tasks.md) | Implementation tasks (BMAD-method) | 01-19-2026 |

## Known Gotchas

### OpenTUI Specifics
- Uses Yoga for flexbox layout (not CSS)
- Mouse events require explicit handlers
- Scrollbox needs `stickyScroll` for auto-scroll behavior

### GLM API Specifics
- Thinking mode enabled by default on GLM-4.7
- Must preserve `reasoning_content` in conversation history
- Coding Plan endpoint: `https://api.z.ai/api/coding/paas/v4/`
- No silent fallbacks - explicit error handling required

### Streaming
- Use 16ms event batching to prevent flicker
- `batch()` from solid-js for coalesced updates
- `reconcile()` for efficient deep state updates

## Decision Log

| Date | Decision | Rationale |
|------|----------|-----------|
| 01-19-2026 | Use OpenTUI + SolidJS | Flicker-free rendering, Zig-powered performance |
| 01-19-2026 | Single API key for all MCPs | Simplified configuration, better UX |
| 01-19-2026 | Tab for mode switching | Discoverable, matches user mental model |
| 01-19-2026 | Brutalist design | Function over form, terminal-native aesthetic |
| 01-19-2026 | No @ syntax for subagents | Agent controls delegation, simpler UX |
| 01-19-2026 | 70% auto-compact threshold | Balance between context preservation and limits |
| 01-19-2026 | Double-press safety (Esc, Ctrl+C) | Prevent accidental interruption/exit |

## How to Run

```bash
# Install dependencies
bun install

# Run in development mode
bun run dev

# Build for production
bun run build

# Run production build
bun run start
```

## How to Test

```bash
# Run all tests
bun test

# Run tests in watch mode
bun test --watch

# Run specific test file
bun test src/path/to/test.ts
```

## Project Structure (Planned)

```
glm-cli/
├── .opencode/skills/        # AI assistance skills
├── docs/                    # Project documentation
├── src/
│   ├── index.ts            # CLI entry point
│   ├── agent/              # GLM agent and subagents
│   ├── api/                # Z.AI API client
│   ├── mcp/                # MCP server integrations
│   ├── session/            # Session management
│   ├── tools/              # Built-in tools
│   ├── ui/                 # OpenTUI components
│   │   ├── components/     # Reusable UI components
│   │   └── context/        # SolidJS contexts
│   ├── input/              # Input handling (paste, @refs)
│   └── utils/              # Utilities
├── AGENTS.md               # This file
├── PRINCIPLES.md           # Non-negotiable rules
├── README.md               # Project overview
└── package.json
```

## Instruction File Discovery

glm-cli checks for project instructions in this order:

1. `.glm-cli/instructions.md`
2. `AGENTS.md`
3. `CLAUDE.md`
4. `GEMINI.md`
5. `QWEN.md`
6. `KIMI.md`
7. `COPILOT.md`
8. `.cursorrules`
9. `.windsurfrules`
