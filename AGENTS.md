# AGENTS.md

> Auto-generated by glm-cli. This is the project brain.

## Project Overview

**glm-cli** is a terminal-based AI coding agent powered by Zhipu AI's GLM-4.x models. It provides a brutally minimal, flicker-free terminal UI for interactive AI-assisted software development.

### Identity

- **Name:** glm-cli
- **Version:** v0.1.0
- **Tagline:** AI coding agent powered by GLM-4.7
- **Design:** Brutally minimal
- **License:** MIT

## Current State

**Status:** Phase 8 COMPLETE - Integration Wiring (discovered during testing)

### Phase 1 Completed Tasks
- [x] Task 1.1: Initialize Project
- [x] Task 1.2: Global Paths Configuration
- [x] Task 1.3: Storage Module
- [x] Task 1.4: File Locking Utility
- [x] Task 1.5: Event Bus
- [x] Task 1.6: Configuration System
- [x] Task 1.7: Logger Utility
- [x] Task 1.8: GLM API Client
- [x] Task 1.9: Streaming Handler
- [x] Task 1.10: Instruction File Discovery
- [x] Task 1.11: Design Constants File

### Phase 2 Completed Tasks
- [x] Task 2.1: OpenTUI App Shell
- [x] Task 2.2: Status Line Component
- [x] Task 2.3: Input Area Component
- [x] Task 2.4: Chat View Component
- [x] Task 2.5: Message Block Component
- [x] Task 2.6: Thinking Block Component
- [x] Task 2.7: Tool Block Component
- [x] Task 2.8: Sidebar Panel Component
- [x] Task 2.9: Todo Item Component
- [x] Task 2.10: Overlay System
- [x] Task 2.11: Mode Context
- [x] Task 2.12: Session Context
- [x] Task 2.13: Todo Context
- [x] Task 2.14: Keyboard Shortcuts

### Phase 3 Completed Tasks
- [x] Task 3.1: MCP Manager
- [x] Task 3.2: Vision MCP (Stdio)
- [x] Task 3.3: Web Search MCP (HTTP)
- [x] Task 3.4: Web Reader MCP (HTTP)
- [x] Task 3.5: Zread MCP (HTTP)
- [x] Task 3.6: MCP Status Overlay

### Phase 4 Completed Tasks
- [x] Task 4.1: Paste Handler
- [x] Task 4.2: Image Paste Handler
- [x] Task 4.3: @ Reference Parser
- [x] Task 4.4: Autocomplete Dropdown
- [x] Task 4.5: Message History Navigation

### Phase 5 Completed Tasks
- [x] Task 5.1: Tool Registry
- [x] Task 5.2: Tool Description Files
- [x] Task 5.3: File Read Tool
- [x] Task 5.4: File Write Tool
- [x] Task 5.5: File Edit Tool
- [x] Task 5.6: Glob Tool
- [x] Task 5.7: Grep Tool
- [x] Task 5.8: Bash Tool
- [x] Task 5.9: Todo Data Model
- [x] Task 5.10: TodoWrite Tool
- [x] Task 5.11: TodoRead Tool
- [x] Task 5.12: Task Tool (Subagent Launcher)
- [x] Task 5.13: Agent Orchestrator
- [x] Task 5.14: Subagents

### Phase 6 Completed Tasks
- [x] Task 6.1: Session Store
- [x] Task 6.2: Checkpoint System
- [x] Task 6.3: Auto-Compact
- [x] Task 6.4: Session Manager
- [x] Task 6.5: Command Registry
- [x] Task 6.6: Core Commands
- [x] Task 6.7: Utility Commands
- [x] Task 6.8: Info Commands

### Phase 7 Completed Tasks
- [x] Task 7.1: Error Handling Polish
- [x] Task 7.2: Performance Optimization
- [x] Task 7.3: 16ms Event Batching
- [x] Task 7.4: Accessibility Review
- [x] Task 7.5: Testing
- [x] Task 7.6: Release Preparation

### Phase 8: Integration Wiring (COMPLETE)

**Background:** Phases 1-7 built all infrastructure in silos. Testing revealed App.tsx was never wired up to use them - it showed hardcoded placeholder data. Phase 8 connects everything.

- [x] Task 8.1: Context Provider Integration
- [x] Task 8.2: API Key Check and Welcome Screen
- [x] Task 8.3: Input Submission to GLMClient
- [x] Task 8.4: Session Manager Integration
- [x] Task 8.5: Final Integration Testing

## Version Bumping Protocol

**CRITICAL:** AI agents MUST follow this semantic versioning workflow when creating commits/PRs.

### Semantic Versioning Format

Version numbers follow format: **MAJOR.MINOR.PATCH** (e.g., 0.1.0)

- **MAJOR** (X.0.0): Breaking changes, API changes, architectural overhauls
  - Example: 0.5.2 → 1.0.0
- **MINOR** (0.X.0): New features, new components, significant enhancements (backwards compatible)
  - Example: 0.1.0 → 0.2.0
- **PATCH** (0.0.X): Bug fixes, typos, minor tweaks, performance improvements (backwards compatible)
  - Example: 0.1.0 → 0.1.1

### AI Agent Workflow for Version Bumping

**Step 1: Analyze Changes**
Before committing or tagging, review all changes and categorize them.

**Step 2: Ask User for Confirmation**
Present your analysis to the user and ask for confirmation:
```
Based on changes in this session, I've identified:
- [List key changes]

I recommend a [PATCH/MINOR/MAJOR] version bump because [reasoning].

Current version: X.Y.Z
Proposed version: X.Y.Z

Does this classification seem correct? Should I proceed with this version bump?
```

**Step 3: Update What's New (Changelog)**
Before bumping version, update CHANGELOG.md:
- Add new entry at TOP of changelog
- Use current date in format "YYYY-MM-DD"
- Set type to "patch", "minor", or "major"
- Write clear, user-friendly title
- List changes as bullet points describing what users will see/experience
- Keep descriptions concise and benefit-focused

**Step 4: Apply Version Bump**
After updating changelog, bump version:
```bash
bun version patch  # or minor, or major
git commit -m "chore: bump version to X.Y.Z"
```

**Step 5: Document in Commit**
- Update commit message to include new version
- Mention version bump and reasoning in commit description
- List what changed to justify bump type

### Decision Tree for AI Agents

**MAJOR bump (X.0.0)** - Use when:
- Removing or renaming public components or APIs
- Changing component props in breaking ways
- Restructuring application architecture
- Changing build output or deployment requirements
- Any change that requires users/developers to modify their code

**MINOR bump (0.X.0)** - Use when:
- Adding new feature or component
- Adding new props or options (backwards compatible)
- Significant enhancement to existing feature
- Adding new API endpoints or services
- Adding new agents, tools, or commands
- New user-facing functionality

**PATCH bump (0.0.X)** - Use when:
- Fixing bugs or errors
- Correcting typos in UI text or documentation
- Improving error messages or logging
- CSS/styling fixes or adjustments
- Performance optimizations (no API changes)
- Accessibility improvements
- Dependency updates (no breaking changes)
- Security patches

**SKIP version bump** - Use when:
- Updating documentation only (README, comments)
- Modifying AGENTS.md or workflow files
- Changing CI/CD configurations
- Updating .gitignore or similar tooling files
- In these cases, note "version: skip" in commit

### Examples

**PATCH: 0.1.0 → 0.1.1**
- "Fix type error in InputArea component"
- "Correct tool result formatting"
- "Improve error handling in API client"

**MINOR: 0.1.0 → 0.1.1**
- "Add @ reference autocomplete"
- "Implement message history navigation"
- "Add MCP status overlay"

**MAJOR: 0.5.2 → 1.0.0**
- "Redesign tool execution architecture"
- "Remove deprecated agent API"
- "Change from direct tool calls to orchestration pattern"

### Integration with Existing Workflow

Version bumping happens after task completion, before committing:

1. Complete task (feature, fix, enhancement)
2. **Analyze changes and ask user about version bump type**
3. **Update CHANGELOG.md** (if applicable)
4. **Bump version**: `bun version patch/minor/major`
5. Commit: `git commit -m "feat/diff/fix: description"`
6. Create git tag: `git tag -a v0.X.Y -m "Release v0.X.Y"`
7. **Ask user before pushing**: Push tags and commits?

### Verification Commands

```bash
# Check current version
grep '"version"' package.json

# Check if tags exist
git tag -l | tail -5

# View recent version bumps
git log --oneline --grep="version" -10
```

### When You Forget

If a commit was made without version bump:
1. Run `bun version patch/minor/major`
2. Commit: `git commit -m "chore: bump version to X.Y.Z"`
3. Create tag: `git tag -a v0.X.Y -m "Release v0.X.Y"`

### Human Override

Users can always override AI agent version decisions:
- Manually edit package.json
- Run `bun version X.Y.Z` to set specific version
- Document reasoning in commit comments
- AI agents should defer to user judgment when corrected

## Tech Stack

| Category | Technology |
|----------|------------|
| **Runtime** | Bun / Node.js 20+ |
| **Language** | TypeScript (strict mode) |
| **UI Framework** | OpenTUI with SolidJS reconciler |
| **API** | Z.AI API (OpenAI-compatible) |
| **Endpoint** | `https://api.z.ai/api/coding/paas/v4/` |

### Dependencies

```json
{
  "@opentui/core": "^0.1.74",
  "@opentui/solid": "^0.1.74",
  "solid-js": "^1.9.0",
  "openai": "^4.73.0",
  "zod": "^3.24.0"
}
```

### Required Configuration

**tsconfig.json** must include:
```json
{
  "compilerOptions": {
    "jsx": "preserve",
    "jsxImportSource": "@opentui/solid"
  }
}
```

**bunfig.toml** must include:
```toml
preload = ["@opentui/solid/preload"]
```

## Models Supported

| Model | Type | Best For |
|-------|------|----------|
| `glm-4.7` | Text | Flagship - complex coding, reasoning (default) |
| `glm-4.7-flash` | Text | Fast flagship variant |
| `glm-4.6` | Text | Previous gen flagship |
| `glm-4.6v` | Vision | Image understanding |
| `glm-4.5` | Text | Efficient general model |
| `glm-4.5-air` | Text | Lightweight, fast |
| `glm-4.5-flash` | Text | Ultra-fast |
| `glm-4.5v` | Vision | Quick image tasks |

## Modes

| Mode | Color | Hex | Purpose | Tools |
|------|-------|-----|---------|-------|
| **AUTO** | White | `#ffffff` | AI decides based on prompt | Switches dynamically |
| **AGENT** | Cyan | `#5cffff` | Full execution + looper skill | All tools |
| **PLANNER** | Purple | `#b48eff` | Research + documentation | Read-only + docs/ |
| **PLAN-PRD** | Blue | `#5c8fff` | Quick PRD via Q&A | Read-only + docs/ |
| **DEBUG** | Orange | `#ffaa5c` | 7-step systematic debugging | All tools |

## Visual Design System

### Design Philosophy: Brutally Minimal

1. **Function over decoration** - Every element serves a purpose
2. **Raw and honest** - No unnecessary embellishment
3. **Dense and information-forward** - Maximize useful content
4. **High contrast** - Clear visual hierarchy
5. **Monospace precision** - Embrace the grid
6. **No emojis** - ASCII indicators only

### Color Palette

**Mode Colors:**
| Mode | Color | Hex |
|------|-------|-----|
| AUTO | White | `#ffffff` |
| AGENT | Cyan | `#5cffff` |
| PLANNER | Purple | `#b48eff` |
| PLAN-PRD | Blue | `#5c8fff` |
| DEBUG | Orange | `#ffaa5c` |

**Status Colors:**
| Status | Color | Hex |
|--------|-------|-----|
| Success | Green | `#6fca6f` |
| Warning | Yellow | `#e6c655` |
| Error | Red | `#ff6b6b` |
| Info | Blue | `#5c8fff` |

**UI Colors:**
| Purpose | Color | Hex |
|---------|-------|-----|
| Primary accent | Cyan | `#5cffff` |
| Secondary/Dim | Gray | `#666666` |
| Primary text | White | `#ffffff` |
| Diff addition | Green | `#6fca6f` |
| Diff deletion | Red | `#ff6b6b` |

### ASCII Indicators

```
Status:
  ▶  Collapsed/play
  ▼  Expanded
  ●  Status dot
  
Todo:
  [ ]  Pending (muted)
  [>]  In progress (cyan)
  [x]  Completed (muted)
  [-]  Cancelled (muted)

Tool Results:
  [OK]    Success (green)
  [FAIL]  Failure (red)

Progress Bar:
  [████████░░] 80%
  █  Filled block
  ░  Empty block

Loading Spinner (DNA Helix):
  ⣾ ⣽ ⣻ ⢿ ⡿ ⣟ ⣯ ⣷  (rotating braille pattern)
  Stacked vertically with gradient colors (cyan to dim)
  Appears left of input box when AI is processing
```

### Layout Mockups

**Main Session View:**
```
┌────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
│ [GLM-CLI] | Implementing API client                                                                        │
│────────────────────────────────────────────────────────────────────────────────────────────────────────────│
│                                                                 │ ▼ Todo (2)                               │
│  You                                              12:34 PM      │   [ ] Set up project structure           │
│  Can you help me implement the API client?                      │   [>] Implement API client               │
│                                                                 │                                          │
│  GLM-4.7                                          12:34 PM      │                                          │
│  I'll help you implement the API client.                        │                                          │
│                                                                 │                                          │
│  ▶ file_write src/api/types.ts                          [OK]    │                                          │
│  ▶ file_write src/api/client.ts                         [OK]    │                                          │
│                                                                 │                                          │
├─────────────────────────────────────────────────────────────────┤                                          │
│ ┌─ AGENT (Thinking) ────────────────────────────────────────┐   │                                          │
│ │  > _                                                      │   │                                          │
│ └───────────────────────────────────────────────────────────┘   │                                          │
├─────────────────────────────────────────────────────────────────┴──────────────────────────────────────────┤
│ GLM-4.7 │ AGENT │ [██████░░░░] 62% │ ~/glm-cli │  main │ MCP: ● │ 01-20-2026                              │
└────────────────────────────────────────────────────────────────────────────────────────────────────────────┘
```

**Welcome Screen:**
```
┌────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
│                                                                                                            │
│     ██████╗ ██╗     ███╗   ███╗       ██████╗██╗     ██╗                                                   │
│    ██╔════╝ ██║     ████╗ ████║      ██╔════╝██║     ██║                                                   │
│    ██║  ███╗██║     ██╔████╔██║█████╗██║     ██║     ██║                                                   │
│    ██║   ██║██║     ██║╚██╔╝██║╚════╝██║     ██║     ██║                                                   │
│    ╚██████╔╝███████╗██║ ╚═╝ ██║      ╚██████╗███████╗██║                                                   │
│     ╚═════╝ ╚══════╝╚═╝     ╚═╝       ╚═════╝╚══════╝╚═╝                                                   │
│                                                                                                            │
│    v0.1.0                                                              built 01-20-2026                    │
│    Model: GLM-4.7                                                      Dir: ~/glm-cli                      │
│                                                                                                            │
└────────────────────────────────────────────────────────────────────────────────────────────────────────────┘

┌─ AUTO (Thinking) ──────────────────────────────────────────────────────────────────────────────────────────┐
│  > _                                                                                                       │
│    What are we building, breaking, or making better?                                                       │
└────────────────────────────────────────────────────────────────────────────────────────────────────────────┘
GLM-4.7 │ AUTO │ [░░░░░░░░░░] 0% │ ~/glm-cli │  main │ MCPs: 4/4 │ 01-20-2026
```

**Status Line Format:**
```
GLM-4.7 │ AGENT │ [██████░░░░] 62% │ ~/glm-cli │  main │ MCPs: 4/4 │ 01-20-2026
   │        │            │              │           │          │          │
   │        │            │              │           │          │          └── Date
   │        │            │              │           │          └── MCP connection status
   │        │            │              │           └── Git branch
   │        │            │              └── Working directory (truncated)
   │        │            └── Context usage progress bar
   │        └── Mode (color-coded)
   └── Model name
```

**Tool Block (Collapsed/Expanded):**
```
▶ file_read src/api/client.ts                                                     [OK]

▼ file_read src/api/client.ts                                                     [OK]
  ┌────────────────────────────────────────────────────────────────────────────────────┐
  │  1  import { OpenAI } from "openai"                                                │
  │  2                                                                                 │
  │  3  export class GLMClient {                                                       │
  └────────────────────────────────────────────────────────────────────────────────────┘
```

**Session End Summary:**
```
────────────────────────────────────────────────────────────────────────────────────────
  GLM-CLI SESSION COMPLETE
────────────────────────────────────────────────────────────────────────────────────────

  Duration        1h 23m 45s
  Modes           AGENT (primary) → PLANNER (1 switch)
  
────────────────────────────────────────────────────────────────────────────────────────
  TOOLS
────────────────────────────────────────────────────────────────────────────────────────

  Calls           15 total        12 success      3 failed
  Code            +142 lines      -38 lines

────────────────────────────────────────────────────────────────────────────────────────

  Until next time!

────────────────────────────────────────────────────────────────────────────────────────
```

## OpenTUI Patterns (SolidJS)

### Critical Rules

1. **Never use `process.exit()` directly** - Use `renderer.destroy()` for clean exit
2. **Use underscore naming for multi-word components** - `<tab_select>`, `<ascii_font>`, `<line_number>`
3. **Use `onInput` not `onChange` for inputs** - Solid convention
4. **Call signals with `()`** - `count()` not `count`
5. **Don't destructure props** - Use `props.value` not `{ value }`
6. **ScrollBox needs explicit height** - Always set `height` prop
7. **FlexGrow needs sized parent** - Parent must have explicit dimensions
8. **Use `onCleanup()` for intervals/subscriptions**

### Component Patterns

**Text Styling (nested modifiers):**
```tsx
<text>
  <span fg="#5cffff"><strong>AGENT</strong></span>
  <span fg="#666666"> │ </span>
  <span fg="#ffffff">GLM-4.7</span>
</text>
```

**Input with Solid:**
```tsx
<input
  value={value()}           // Signal accessor with ()
  onInput={setValue}        // Not onChange!
  placeholder="..."
  focused                   // Required for keyboard input
/>
```

**Select Events:**
| Event | Trigger | Use |
|-------|---------|-----|
| `onSelect` | Enter pressed | Confirm selection |
| `onChange` | Arrow keys | Preview/navigate |

### Hooks Reference

- `useRenderer()` - Access renderer for cleanup
- `useKeyboard(handler, options?)` - Keyboard events
- `usePaste(handler)` - Paste events
- `useTerminalDimensions()` - Reactive terminal size
- `useTimeline(options?)` - Animations

## Agents

| Agent | Mode | Tools | Purpose |
|-------|------|-------|---------|
| `build` | Primary | All | Main coding agent |
| `explore` | Subagent | Read-only (grep, glob, read) | Fast codebase search |
| `general` | Subagent | Most (no todo) | Complex multi-step tasks |

Agent-controlled delegation (no @ syntax for users).

## Session Header

Dynamic header line at the top of the session screen showing context about the current conversation/task. Similar to how ChatGPT/Claude/Gemini auto-generate chat titles.

### Format

```
[GLM-CLI] | <context>
```

### Header States

| Scenario | Format | Example |
|----------|--------|---------|
| New session | `[GLM-CLI] \| New session` | `[GLM-CLI] \| New session` |
| AI sets context | `[GLM-CLI] \| <description>` | `[GLM-CLI] \| Express mode permission system` |
| After `/compact` | `[GLM-CLI] \| Compacted: <description>` | `[GLM-CLI] \| Compacted: Express mode` |
| After `/undo` | `[GLM-CLI] \| Reverted: <description>` | `[GLM-CLI] \| Reverted: Express mode` |
| After `/redo` | `[GLM-CLI] \| Reapplied: <description>` | `[GLM-CLI] \| Reapplied: Express mode` |
| After `/load` | Restore saved header | `[GLM-CLI] \| Express mode permission system` |

### Tool: `set_header`

AI uses the `set_header` tool to update the header. Guidelines:
- Set at meaningful milestones (initial understanding, phase changes)
- Do NOT update constantly
- Keep titles concise (max 50 characters)
- Let the description naturally indicate the action

### Persistence

- Header title persists with session on `/save`
- Restored when session is loaded via `/load`
- Prefixes (Compacted/Reverted/Reapplied) are cleared on next AI update

## Todo System

Session-scoped task management for tracking complex, multi-step work.

### Data Model

```typescript
interface Todo {
  id: string        // Unique identifier
  content: string   // Brief task description
  status: string    // pending | in_progress | completed | cancelled
  priority: string  // high | medium | low
}
```

### Tools

| Tool | Purpose |
|------|---------|
| `TodoWrite` | Replace entire todo list (full replacement) |
| `TodoRead` | Read current session todos |

### UI Display

Todos appear in the sidebar panel:
- `[ ]` = pending (muted)
- `[>]` = in_progress (cyan)
- `[x]` = completed (muted)

Section collapses when >2 items, hides when all completed.

### Agent Usage

- Use for tasks with 3+ steps
- Only ONE todo `in_progress` at a time
- Mark complete IMMEDIATELY after finishing
- Don't use for trivial single-step tasks

## Question Tool

Interactive question tool for structured user input. Allows the AI to ask multiple-choice questions and receive user selections.

### Schema

```typescript
interface Question {
  question: string;           // Full question text
  header: string;             // Short label (max 12 chars)
  options: {
    label: string;            // 1-5 words
    description: string;      // Explanation
  }[];
  multiple?: boolean;         // Multi-select (default: false)
}

// Tool output
interface QuestionToolOutput {
  answers: string[][];  // Selected labels per question
}
```

### UI Mockup

```
┌─ HEADER ─────────────────────────────────────────────────┐
│                                                          │
│ Question text here?                                      │
│                                                          │
│ (*) Option 1 label                                       │
│     Description of option 1                              │
│                                                          │
│ ( ) Option 2 label                                       │
│     Description of option 2                              │
│                                                          │
│ ( ) Other...                                             │
│     Provide custom text input                            │
│                                                          │
├──────────────────────────────────────────────────────────┤
│ [1/3]  Tab: Next  Enter: Select  Esc: Cancel             │
└──────────────────────────────────────────────────────────┘
```

### Agent Usage

- Use for gathering user preferences or requirements
- Use for clarifying ambiguous instructions
- Use for getting decisions on implementation choices
- Users can always select "Other" to provide custom text
- Keep headers to max 12 characters
- Keep option labels concise (1-5 words)
- First option is typically the recommended choice

## MCP Servers

5 MCP servers are configured (4 Z.AI + Context7):

| Server | Type | Tools |
|--------|------|-------|
| **Vision** | Local (stdio) | `ui_to_artifact`, `extract_text_from_screenshot`, `diagnose_error_screenshot`, `understand_technical_diagram`, `analyze_data_visualization`, `ui_diff_check`, `image_analysis`, `video_analysis` |
| **Web Search** | Remote (HTTP) | `webSearchPrime` |
| **Web Reader** | Remote (HTTP) | `webReader` |
| **Zread** | Remote (HTTP) | `search_doc`, `get_repo_structure`, `read_file` |
| **Context7** | Remote (HTTP) | `resolve-library-id`, `query-docs` |

**Note:** The agent discovers MCP tools on-demand using `/mcp-tools search <query>` rather than preloading all tool descriptions into context. This keeps the context window lean.

## Commands

| Command | Description |
|---------|-------------|
| `/new` | New session (prompt to save) |
| `/compact` | Manual AI summarization |
| `/save` | Save with AI-suggested name |
| `/load` | Session picker with preview |
| `/undo` | Git-based revert to checkpoint |
| `/redo` | Restore undone changes |
| `/model` | Switch GLM model |
| `/mode` | Switch mode (alt to Tab) |
| `/instruct` | Edit project instructions |
| `/config` | Basic settings overlay |
| `/stats` | Session statistics |
| `/help` | Categorized help overlay |
| `/think` | Toggle thinking mode |
| `/quit` | Exit with summary |
| `/exit` | Exit with summary |

## Keyboard Shortcuts

| Key | Action |
|-----|--------|
| `Tab` | Cycle modes |
| `Shift+Tab` | Cycle modes reverse |
| `Enter` | Submit / Select |
| `Shift+Enter` | Line break in input |
| `↑/↓` | Navigate / Scroll |
| `@` | File/directory autocomplete |
| `Esc` (2x) | Cancel / Stop operation |
| `Ctrl+C` (2x) | Exit with summary |
| `Ctrl+B` | Toggle sidebar |
| `Ctrl+M` | MCP status overlay |
| `Ctrl+P` | Command palette |

## Project Conventions

### Code Style
- TypeScript strict mode
- No `any` types
- Prefer functional components
- Use Zod for runtime validation

### Naming
- Files: kebab-case (`status-line.tsx`)
- Components: PascalCase (`StatusLine`)
- Functions: camelCase (`createSession`)
- Constants: UPPER_SNAKE_CASE (`MAX_RETRIES`)

### Commits
- Conventional commits format
- Commit after each discrete task
- No `git push` without explicit permission

### UI
- No emojis anywhere
- Brutalist aesthetic
- 16ms event batching for streaming
- 60fps target

### UI Change Protocol (CRITICAL)
**ALWAYS create an ASCII mockup before implementing any UI changes.**

When proposing or implementing UI modifications:
1. **Create a mockup first** - Show the intended layout using ASCII art
2. **Get approval** - Wait for user confirmation before implementing
3. **Reference the mockup** - Keep the mockup visible during implementation

Example mockup format:
```
┌─ COMPONENT NAME ────────────────────────────────────────────┐
│                                                             │
│  [Element description]                                      │
│  [Another element]                                          │
│                                                             │
│  ┌─ Nested Component ─────────────────────────────────────┐ │
│  │  Content here                                          │ │
│  └────────────────────────────────────────────────────────┘ │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

This ensures:
- User can visualize changes before code is written
- Prevents wasted effort on unwanted designs
- Documents UI decisions for future reference

### UI Implementation References (CRITICAL)
**ALWAYS consult these resources before implementing visual changes:**

1. **OpenTUI Skill** (`.opencode/skill/opentui/`)
   - Check `references/solid/` for SolidJS-specific patterns
   - Check `references/keyboard/` for navigation/selection patterns
   - Check `references/layout/` for layout and list patterns
   - Check `references/components/` for component examples

2. **Context7 MCP** - Query library documentation:
   ```
   /mcp-tools context7 resolve-library-id  # Find library ID
   /mcp-tools context7 query-docs          # Query docs
   ```

3. **Existing Codebase Patterns** - Check similar components:
   - `src/ui/components/Autocomplete.tsx` - List selection with highlighting
   - `src/ui/components/Overlay.tsx` - Command palette selection
   - `src/ui/components/InputArea.tsx` - Dropdown autocomplete

**Key OpenTUI Patterns:**
- Use `<box backgroundColor={...}>` for highlight backgrounds (not `style={}`)
- Use `<text fg={...}>` for text colors
- Use `<Show when={...}>` for conditional rendering, not ternaries in props
- Selection: Change `fg` color AND optionally `backgroundColor` on container

## Generated Documentation

| Document | Purpose | Generated |
|----------|---------|-----------|
| [docs/Requirements.md](docs/Requirements.md) | Functional and non-functional requirements | 01-19-2026 |
| [docs/Design.md](docs/Design.md) | Architecture and visual design system | 01-20-2026 |
| [docs/Tasks.md](docs/Tasks.md) | Implementation tasks (BMAD-method) | 01-20-2026 |

## Installed Skills

| Skill | Location | Purpose |
|-------|----------|---------|
| OpenTUI | `.opencode/skill/opentui/` | TUI development with Core, React, Solid reconcilers |
| Frontend Design | `.opencode/skills/frontend-design/` | Brutalist terminal UI design patterns |
| Agent Browser | `.opencode/skills/agent-browser/` | Browser automation for research |

## Known Gotchas

### OpenTUI Specifics
- Uses Yoga for flexbox layout (not CSS)
- Mouse events require explicit handlers
- Scrollbox needs `stickyScroll` for auto-scroll behavior
- Never call `process.exit()` - use `renderer.destroy()`
- Solid uses underscores: `<tab_select>`, `<ascii_font>`, `<line_number>`
- Text styling requires nested tags: `<strong>`, `<em>`, `<span fg="...">`

### GLM API Specifics
- Thinking mode enabled by default on GLM-4.7
- Must preserve `reasoning_content` in conversation history
- Coding Plan endpoint: `https://api.z.ai/api/coding/paas/v4/`
- No silent fallbacks - explicit error handling required

### Streaming
- Use 16ms event batching to prevent flicker
- `batch()` from solid-js for coalesced updates
- `reconcile()` for efficient deep state updates

### Configuration
- tsconfig.json needs `jsx: "preserve"` and `jsxImportSource: "@opentui/solid"`
- bunfig.toml needs `preload = ["@opentui/solid/preload"]`
- Use `@opentui/core` not platform-specific packages

## Decision Log

| Date | Decision | Rationale |
|------|----------|-----------|
| 01-19-2026 | Use OpenTUI + SolidJS | Flicker-free rendering, Zig-powered performance |
| 01-19-2026 | Single API key for all MCPs | Simplified configuration, better UX |
| 01-19-2026 | Tab for mode switching | Discoverable, matches user mental model |
| 01-19-2026 | Brutalist design | Function over form, terminal-native aesthetic |
| 01-19-2026 | No @ syntax for subagents | Agent controls delegation, simpler UX |
| 01-19-2026 | 70% auto-compact threshold | Balance between context preservation and limits |
| 01-19-2026 | Double-press safety (Esc, Ctrl+C) | Prevent accidental interruption/exit |
| 01-20-2026 | Install OpenTUI skill | Comprehensive reference for TUI development |
| 01-20-2026 | Install frontend-design skill | Brutalist visual design patterns |
| 01-20-2026 | Add Welcome Screen | First impression, shows key info at startup |
| 01-20-2026 | Enhanced Status Line | Progress bar, git branch, current tool activity |
| 01-20-2026 | Session End Summary | Clean exit with useful stats |
| 01-20-2026 | Design constants file | Single source of truth for colors/indicators |
| 01-20-2026 | Phase 2 UI components | Complete OpenTUI component set for core functionality |
| 01-20-2026 | Context providers | Mode, Session, Todo contexts for state management |
| 01-20-2026 | Global keyboard handler | Tab mode cycling, Ctrl+P/M commands, double-press safety |
| 01-20-2026 | MCP Manager pattern | Single manager class with unified initialization for all 4 MCPs |
| 01-20-2026 | MCP overlay integration | Reuse existing Overlay component for MCP status display |
| 01-20-2026 | Paste detection | Timing-based multi-line paste detection with line count indicator |
| 01-20-2026 | @ reference parser | Fuzzy filename matching, @~ expansion, line range support |
| 01-20-2026 | Input history navigation | Up/down arrow for browsing previous submissions |
| 01-20-2026 | Autocomplete dropdown | Positioned @ reference completion with keyboard navigation |
| 01-21-2026 | MCP auto-discovery | Agent automatically searches MCP tools when task requires external capabilities |
| 01-21-2026 | Hardcoded initial MCPs | Z.AI servers + Context7 as MVP, registry integration later |

## Future Work

### MCP Registry Integration (Planned)

**Goal:** Allow users to search and install MCP servers from the official registry.

**Registry URL:** https://registry.modelcontextprotocol.io/

**Planned UX:**
1. User types `/mcp` and searches for a capability (e.g., "github", "slack", "database")
2. System queries the MCP registry for matching servers
3. User selects a server to install
4. Server is added to local config and initialized

**Why Later:**
- MVP focuses on hardcoded Z.AI + Context7 servers
- Registry integration requires OAuth flows for many servers
- Need to design secure credential storage first

**Technical Notes:**
- Registry API provides server metadata, auth requirements, tool lists
- Some servers require OAuth, others just API keys
- Consider mcp-launchpad patterns for auth handling

## How to Run

```bash
# Install dependencies
bun install

# Run in development mode
bun run dev

# Build for production
bun run build

# Run production build
bun run start
```

## How to Test

```bash
# Run all tests
bun test

# Run tests in watch mode
bun test --watch

# Run specific test file
bun test src/path/to/test.ts
```

## Project Structure

```
glm-cli/
├── .opencode/
│   ├── skill/opentui/       # OpenTUI skill references
│   ├── skills/              # Other skills (frontend-design, etc.)
│   └── command/             # Slash commands
├── docs/                    # Project documentation
├── src/
│   ├── index.tsx           # CLI entry point
│   ├── global.ts           # Global paths configuration
│   ├── agent/              # GLM agent and subagents
│   ├── api/                # Z.AI API client
│   ├── bus/                # Event bus
│   ├── mcp/                # MCP server integrations
│   ├── session/            # Session management
│   ├── storage/            # File-based storage
│   ├── tools/              # Built-in tools
│   ├── ui/                 # OpenTUI components
│   │   ├── components/     # Reusable UI components
│   │   │   ├── ProgressBar.tsx
│   │   │   ├── StatusLine.tsx
│   │   │   ├── InputArea.tsx
│   │   │   ├── ChatView.tsx
│   │   │   ├── MessageBlock.tsx
│   │   │   ├── ThinkingBlock.tsx
│   │   │   ├── ToolBlock.tsx
│   │   │   ├── Sidebar.tsx
│   │   │   ├── TodoItem.tsx
│   │   │   └── Overlay.tsx
│   │   ├── context/        # SolidJS contexts
│   │   │   ├── mode.tsx
│   │   │   ├── session.tsx
│   │   │   └── todo.tsx
│   │   └── design.ts       # Design constants (colors, indicators)
│   ├── input/              # Input handling (paste, @refs)
│   │   ├── shortcuts.ts     # Global keyboard handler
│   │   └── index.ts
│   ├── commands/           # Slash commands
│   ├── modes/              # Mode-specific logic
│   └── util/               # Utilities
├── AGENTS.md               # This file (project brain)
├── PRINCIPLES.md           # Non-negotiable rules
├── README.md               # Project overview
├── package.json
├── tsconfig.json
└── bunfig.toml
```

## Instruction File Discovery

glm-cli checks for project instructions in this order:

1. `.glm-cli/instructions.md`
2. `AGENTS.md`
3. `CLAUDE.md`
4. `GEMINI.md`
5. `QWEN.md`
6. `KIMI.md`
7. `COPILOT.md`
8. `.cursorrules`
9. `.windsurfrules`
