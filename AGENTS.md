# AGENTS.md

> Auto-generated by IMPULSE. This is the project brain.

## Project Overview

**IMPULSE** is a terminal-based AI coding agent powered by GLM-4.x models. It provides a brutally minimal, flicker-free terminal UI for interactive AI-assisted software development. Powered by Z.ai's Coding Plan - the best cost/engineering ratio for builders.

### Identity

- **Name:** IMPULSE
- **Version:** v0.20.2
- **Tagline:** Terminal-based AI coding agent powered by GLM models
- **Design:** Brutally minimal
- **License:** MIT

## Current State

**Status:** Phase 8 COMPLETE - Integration Wiring (discovered during testing)

### Phase 1 Completed Tasks
- [x] Task 1.1: Initialize Project
- [x] Task 1.2: Global Paths Configuration
- [x] Task 1.3: Storage Module
- [x] Task 1.4: File Locking Utility
- [x] Task 1.5: Event Bus
- [x] Task 1.6: Configuration System
- [x] Task 1.7: Logger Utility
- [x] Task 1.8: GLM API Client
- [x] Task 1.9: Streaming Handler
- [x] Task 1.10: Instruction File Discovery
- [x] Task 1.11: Design Constants File

### Phase 2 Completed Tasks
- [x] Task 2.1: OpenTUI App Shell
- [x] Task 2.2: Status Line Component
- [x] Task 2.3: Input Area Component
- [x] Task 2.4: Chat View Component
- [x] Task 2.5: Message Block Component
- [x] Task 2.6: Thinking Block Component
- [x] Task 2.7: Tool Block Component
- [x] Task 2.8: Sidebar Panel Component
- [x] Task 2.9: Todo Item Component
- [x] Task 2.10: Overlay System
- [x] Task 2.11: Mode Context
- [x] Task 2.12: Session Context
- [x] Task 2.13: Todo Context
- [x] Task 2.14: Keyboard Shortcuts

### Phase 3 Completed Tasks
- [x] Task 3.1: MCP Manager
- [x] Task 3.2: Vision MCP (Stdio)
- [x] Task 3.3: Web Search MCP (HTTP)
- [x] Task 3.4: Web Reader MCP (HTTP)
- [x] Task 3.5: Zread MCP (HTTP)
- [x] Task 3.6: MCP Status Overlay

### Phase 4 Completed Tasks
- [x] Task 4.1: Paste Handler
- [x] Task 4.2: Image Paste Handler
- [x] Task 4.3: @ Reference Parser
- [x] Task 4.4: Autocomplete Dropdown
- [x] Task 4.5: Message History Navigation

### Phase 5 Completed Tasks
- [x] Task 5.1: Tool Registry
- [x] Task 5.2: Tool Description Files
- [x] Task 5.3: File Read Tool
- [x] Task 5.4: File Write Tool
- [x] Task 5.5: File Edit Tool
- [x] Task 5.6: Glob Tool
- [x] Task 5.7: Grep Tool
- [x] Task 5.8: Bash Tool
- [x] Task 5.9: Todo Data Model
- [x] Task 5.10: TodoWrite Tool
- [x] Task 5.11: TodoRead Tool
- [x] Task 5.12: Task Tool (Subagent Launcher)
- [x] Task 5.13: Agent Orchestrator
- [x] Task 5.14: Subagents

### Phase 6 Completed Tasks
- [x] Task 6.1: Session Store
- [x] Task 6.2: Checkpoint System
- [x] Task 6.3: Auto-Compact
- [x] Task 6.4: Session Manager
- [x] Task 6.5: Command Registry
- [x] Task 6.6: Core Commands
- [x] Task 6.7: Utility Commands
- [x] Task 6.8: Info Commands

### Phase 7 Completed Tasks
- [x] Task 7.1: Error Handling Polish
- [x] Task 7.2: Performance Optimization
- [x] Task 7.3: 16ms Event Batching
- [x] Task 7.4: Accessibility Review
- [x] Task 7.5: Testing
- [x] Task 7.6: Release Preparation

### Phase 8: Integration Wiring (COMPLETE)

**Background:** Phases 1-7 built all infrastructure in silos. Testing revealed App.tsx was never wired up to use them - it showed hardcoded placeholder data. Phase 8 connects everything.

- [x] Task 8.1: Context Provider Integration
- [x] Task 8.2: API Key Check and Welcome Screen
- [x] Task 8.3: Input Submission to GLMClient
- [x] Task 8.4: Session Manager Integration
- [x] Task 8.5: Final Integration Testing

## Version Bumping Protocol

**CRITICAL:** AI agents MUST follow this semantic versioning workflow when creating commits/PRs.

### Semantic Versioning Format

Version numbers follow format: **MAJOR.MINOR.PATCH** (e.g., 0.1.0)

**Pre-1.0 Versioning (Current):**
- Version 0.x.y continues until 0.100.0, then becomes 1.0.0
- MINOR can go from 0 to 100 (e.g., 0.9.5 → 0.10.0 → ... → 0.100.0 → 1.0.0)
- PATCH can go from 0 to 99 within each minor (e.g., 0.9.0 → 0.9.99 → 0.10.0)

**Version Bump Rules:**
- **MAJOR** (X.0.0): Breaking changes, API changes, architectural overhauls
  - Pre-1.0: Only bump to 1.0.0 when reaching 0.100.0 OR when project is production-ready
  - Example: 0.100.0 → 1.0.0
- **MINOR** (0.X.0): New features, new components, significant enhancements (backwards compatible)
  - Example: 0.9.5 → 0.10.0
- **PATCH** (0.0.X): Bug fixes, typos, minor tweaks, performance improvements (backwards compatible)
  - Example: 0.9.5 → 0.9.6

### AI Agent Workflow for Version Bumping

**Step 1: Analyze Changes**
Before committing or tagging, review all changes and categorize them.

**Step 2: Ask User for Confirmation**
Present your analysis to the user and ask for confirmation:
```
Based on changes in this session, I've identified:
- [List key changes]

I recommend a [PATCH/MINOR/MAJOR] version bump because [reasoning].

Current version: X.Y.Z
Proposed version: X.Y.Z

Does this classification seem correct? Should I proceed with this version bump?
```

**Step 3: Update What's New (Changelog)**
Before bumping version, update CHANGELOG.md:
- Add new entry at TOP of changelog
- Use current date in format "YYYY-MM-DD"
- Set type to "patch", "minor", or "major"
- Write clear, user-friendly title
- List changes as bullet points describing what users will see/experience
- Keep descriptions concise and benefit-focused

**Step 4: Apply Version Bump**
After updating changelog, bump version:
```bash
bun version patch  # or minor, or major
git commit -m "chore: bump version to X.Y.Z"
```

**Step 5: Document in Commit**
- Update commit message to include new version
- Mention version bump and reasoning in commit description
- List what changed to justify bump type

### Decision Tree for AI Agents

**MAJOR bump (X.0.0)** - Use when:
- Removing or renaming public components or APIs
- Changing component props in breaking ways
- Restructuring application architecture
- Changing build output or deployment requirements
- Any change that requires users/developers to modify their code

**MINOR bump (0.X.0)** - Use when:
- Adding new feature or component
- Adding new props or options (backwards compatible)
- Significant enhancement to existing feature
- Adding new API endpoints or services
- Adding new agents, tools, or commands
- New user-facing functionality

**PATCH bump (0.0.X)** - Use when:
- Fixing bugs or errors
- Correcting typos in UI text or documentation
- Improving error messages or logging
- CSS/styling fixes or adjustments
- Performance optimizations (no API changes)
- Accessibility improvements
- Dependency updates (no breaking changes)
- Security patches

**SKIP version bump** - Use when:
- Updating documentation only (README, comments)
- Modifying AGENTS.md or workflow files
- Changing CI/CD configurations
- Updating .gitignore or similar tooling files
- In these cases, note "version: skip" in commit

### Examples

**PATCH: 0.1.0 → 0.1.1**
- "Fix type error in InputArea component"
- "Correct tool result formatting"
- "Improve error handling in API client"

**MINOR: 0.1.0 → 0.1.1**
- "Add @ reference autocomplete"
- "Implement message history navigation"
- "Add MCP status overlay"

**MAJOR: 0.5.2 → 1.0.0**
- "Redesign tool execution architecture"
- "Remove deprecated agent API"
- "Change from direct tool calls to orchestration pattern"

### Integration with Existing Workflow

Version bumping happens after task completion, before committing:

1. Complete task (feature, fix, enhancement)
2. **Analyze changes and ask user about version bump type**
3. **Update CHANGELOG.md** (if applicable)
4. **Bump version**: `bun version patch/minor/major`
5. Commit: `git commit -m "feat/diff/fix: description"`
6. Create git tag: `git tag -a v0.X.Y -m "Release v0.X.Y"`
7. **Ask user before pushing**: Push tags and commits?

### Verification Commands

```bash
# Check current version
grep '"version"' package.json

# Check if tags exist
git tag -l | tail -5

# View recent version bumps
git log --oneline --grep="version" -10
```

### When You Forget

If a commit was made without version bump:
1. Run `bun version patch/minor/major`
2. Commit: `git commit -m "chore: bump version to X.Y.Z"`
3. Create tag: `git tag -a v0.X.Y -m "Release v0.X.Y"`

### Human Override

Users can always override AI agent version decisions:
- Manually edit package.json
- Run `bun version X.Y.Z` to set specific version
- Document reasoning in commit comments
- AI agents should defer to user judgment when corrected

## Tech Stack

| Category | Technology |
|----------|------------|
| **Runtime** | Bun / Node.js 20+ |
| **Language** | TypeScript (strict mode) |
| **UI Framework** | OpenTUI with SolidJS reconciler |
| **API** | Z.AI API (OpenAI-compatible) |
| **Endpoint** | `https://api.z.ai/api/coding/paas/v4/` |

### Dependencies

```json
{
  "@opentui/core": "^0.1.74",
  "@opentui/solid": "^0.1.74",
  "solid-js": "^1.9.0",
  "openai": "^4.73.0",
  "zod": "^3.24.0"
}
```

### Required Configuration

**tsconfig.json** must include:
```json
{
  "compilerOptions": {
    "jsx": "preserve",
    "jsxImportSource": "@opentui/solid"
  }
}
```

**bunfig.toml** must include:
```toml
preload = ["@opentui/solid/preload"]
```

## Models Supported

| Model | Type | Best For |
|-------|------|----------|
| `glm-4.7` | Text | Flagship - complex coding, reasoning (default) |
| `glm-4.7-flash` | Text | Fast flagship variant |
| `glm-4.6` | Text | Previous gen flagship |
| `glm-4.6v` | Vision | Image understanding |
| `glm-4.5` | Text | Efficient general model |
| `glm-4.5-air` | Text | Lightweight, fast |
| `glm-4.5-flash` | Text | Ultra-fast |
| `glm-4.5v` | Vision | Quick image tasks |

## Modes

| Mode | Color | Hex | Purpose | Tools |
|------|-------|-----|---------|-------|
| **AUTO** | Gray | `#cccccc` | AI decides, starts exploratory | Switches dynamically |
| **EXPLORE** | Green | `#6fca6f` | Read-only understanding - patient, curious | Read-only + web research |
| **AGENT** | Cyan | `#5cffff` | Full execution + looper skill | All tools |
| **PLANNER** | Purple | `#b48eff` | Research + documentation | Read-only + docs/ |
| **PLAN-PRD** | Blue | `#5c8fff` | Quick PRD via Q&A | Read-only + docs/ |
| **DEBUG** | Orange | `#ffaa5c` | 7-step systematic debugging | All tools |

### Mode Switching

All modes are **mode-aware** and will suggest switching when the conversation shifts:

| From | To | Signals |
|------|-----|---------|
| EXPLORE | PLAN-PRD | "I want to build...", "Let's create...", simple feature |
| EXPLORE | PLANNER | Complex feature, needs architecture |
| EXPLORE | DEBUG | "Something's broken...", "This error..." |
| PLAN-PRD | AGENT | Requirements clear, user says "let's do it" |
| PLANNER | AGENT | Plan complete, user approves |
| Any | EXPLORE | "Wait, explain...", "I don't understand..." |

### EXPLORE Mode Personality

EXPLORE is the "conversational" mode - like a traditional ChatGPT experience but with codebase awareness:

- **Patient**: Doesn't rush to solutions, lets user think aloud
- **Curious**: Asks "why" and "what if" questions
- **Anticipatory**: Tries to be 1-2 steps ahead ("Are you thinking about X?")
- **Non-presumptuous**: Suggests but doesn't assume user wants to build

## Visual Design System

### Design Philosophy: Brutally Minimal

1. **Function over decoration** - Every element serves a purpose
2. **Raw and honest** - No unnecessary embellishment
3. **Dense and information-forward** - Maximize useful content
4. **High contrast** - Clear visual hierarchy
5. **Monospace precision** - Embrace the grid
6. **No emojis** - ASCII indicators only

### Color Palette

**Mode Colors:**
| Mode | Color | Hex |
|------|-------|-----|
| AUTO | White | `#ffffff` |
| EXPLORE | Green | `#6fca6f` |
| AGENT | Cyan | `#5cffff` |
| PLANNER | Purple | `#b48eff` |
| PLAN-PRD | Blue | `#5c8fff` |
| DEBUG | Orange | `#ffaa5c` |

**Status Colors:**
| Status | Color | Hex |
|--------|-------|-----|
| Success | Green | `#6fca6f` |
| Warning | Yellow | `#e6c655` |
| Error | Red | `#ff6b6b` |
| Info | Blue | `#5c8fff` |

**UI Colors:**
| Purpose | Color | Hex |
|---------|-------|-----|
| Primary accent | Cyan | `#5cffff` |
| Secondary/Dim | Gray | `#666666` |
| Primary text | White | `#ffffff` |
| Diff addition | Green | `#6fca6f` |
| Diff deletion | Red | `#ff6b6b` |

### ASCII Indicators

```
Status:
  ▶  Collapsed/play
  ▼  Expanded
  ●  Status dot
  
Todo:
  [ ]  Pending (muted)
  [>]  In progress (cyan)
  [x]  Completed (muted)
  [-]  Cancelled (muted)

Tool Results:
  [OK]    Success (green)
  [FAIL]  Failure (red)

Progress Bar:
  [████████░░] 80%
  █  Filled block
  ░  Empty block

Loading Animation (DNA Helix):
  ⣾ ⣽ ⣻ ⢿ ⡿ ⣟ ⣯ ⣷  (rotating braille pattern)
  6 rows stacked vertically with gradient colors (cyan to dim)
  Fixed position LEFT of input box (3-char reserved space)
  Centered vertically against 7-line prompt box
  Animates during AI processing (responding, tool calls, edits, etc.)
```

### Layout Mockups

**Main Session View:**
```
┌────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
│ [IMPULSE] | Implementing API client                                                                        │
│────────────────────────────────────────────────────────────────────────────────────────────────────────────│
│                                                                 │ ▼ Todo (2)                               │
│  You                                              12:34 PM      │   [ ] Set up project structure           │
│  Can you help me implement the API client?                      │   [>] Implement API client               │
│                                                                 │                                          │
│  GLM-4.7                                          12:34 PM      │                                          │
│  I'll help you implement the API client.                        │                                          │
│                                                                 │                                          │
│  ▶ file_write src/api/types.ts                          [OK]    │                                          │
│  ▶ file_write src/api/client.ts                         [OK]    │                                          │
│                                                                 │                                          │
├─────────────────────────────────────────────────────────────────┤                                          │
│ ┌─ AGENT (Thinking) ────────────────────────────────────────┐   │                                          │
│ │  > _                                                      │   │                                          │
│ └───────────────────────────────────────────────────────────┘   │                                          │
├─────────────────────────────────────────────────────────────────┴──────────────────────────────────────────┤
│ GLM-4.7 │ AGENT │ [██████░░░░] 62% │ ~/impulse │  main │ MCP: ● │ 01-20-2026                              │
└────────────────────────────────────────────────────────────────────────────────────────────────────────────┘
```

**Welcome Screen:**
```
┌────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
│                                                                                                            │
│     ██████╗ ██╗     ███╗   ███╗       ██████╗██╗     ██╗                                                   │
│    ██╔════╝ ██║     ████╗ ████║      ██╔════╝██║     ██║                                                   │
│    ██║  ███╗██║     ██╔████╔██║█████╗██║     ██║     ██║                                                   │
│    ██║   ██║██║     ██║╚██╔╝██║╚════╝██║     ██║     ██║                                                   │
│    ╚██████╔╝███████╗██║ ╚═╝ ██║      ╚██████╗███████╗██║                                                   │
│     ╚═════╝ ╚══════╝╚═╝     ╚═╝       ╚═════╝╚══════╝╚═╝                                                   │
│                                                                                                            │
│    v0.1.0                                                              built 01-20-2026                    │
│    Model: GLM-4.7                                                      Dir: ~/impulse                      │
│                                                                                                            │
└────────────────────────────────────────────────────────────────────────────────────────────────────────────┘

┌─ AUTO (Thinking) ──────────────────────────────────────────────────────────────────────────────────────────┐
│  > _                                                                                                       │
│    What are we building, breaking, or making better?                                                       │
└────────────────────────────────────────────────────────────────────────────────────────────────────────────┘
GLM-4.7 │ AUTO │ [░░░░░░░░░░] 0% │ ~/impulse │  main │ MCPs: 4/4 │ 01-20-2026
```

**Status Line Format:**
```
GLM-4.7 │ AGENT │ [██████░░░░] 62% │ ~/impulse │  main │ MCPs: 4/4 │ 01-20-2026
   │        │            │              │           │          │          │
   │        │            │              │           │          │          └── Date
   │        │            │              │           │          └── MCP connection status
   │        │            │              │           └── Git branch
   │        │            │              └── Working directory (truncated)
   │        │            └── Context usage progress bar
   │        └── Mode (color-coded)
   └── Model name
```

**Tool Block (Collapsed/Expanded):**
```
▶ file_read src/api/client.ts                                                     [OK]

▼ file_read src/api/client.ts                                                     [OK]
  ┌────────────────────────────────────────────────────────────────────────────────────┐
  │  1  import { OpenAI } from "openai"                                                │
  │  2                                                                                 │
  │  3  export class GLMClient {                                                       │
  └────────────────────────────────────────────────────────────────────────────────────┘
```

**Session End Summary:**
```
────────────────────────────────────────────────────────────────────────────────────────
  IMPULSE SESSION COMPLETE
────────────────────────────────────────────────────────────────────────────────────────

  Duration        1h 23m 45s
  Modes           AGENT (primary) → PLANNER (1 switch)
  
────────────────────────────────────────────────────────────────────────────────────────
  TOOLS
────────────────────────────────────────────────────────────────────────────────────────

  Calls           15 total        12 success      3 failed
  Code            +142 lines      -38 lines

────────────────────────────────────────────────────────────────────────────────────────

  Until next time!

────────────────────────────────────────────────────────────────────────────────────────
```

## OpenTUI Patterns (SolidJS)

### Critical Rules

1. **Never use `process.exit()` directly** - Use `renderer.destroy()` for clean exit
2. **Use underscore naming for multi-word components** - `<tab_select>`, `<ascii_font>`, `<line_number>`
3. **Use `onInput` not `onChange` for inputs** - Solid convention
4. **Call signals with `()`** - `count()` not `count`
5. **Don't destructure props** - Use `props.value` not `{ value }`
6. **ScrollBox needs explicit height** - Always set `height` prop
7. **FlexGrow needs sized parent** - Parent must have explicit dimensions
8. **Use `onCleanup()` for intervals/subscriptions**

### Component Patterns

**Text Styling (nested modifiers):**
```tsx
<text>
  <span fg="#5cffff"><strong>AGENT</strong></span>
  <span fg="#666666"> │ </span>
  <span fg="#ffffff">GLM-4.7</span>
</text>
```

**Input with Solid:**
```tsx
<input
  value={value()}           // Signal accessor with ()
  onInput={setValue}        // Not onChange!
  placeholder="..."
  focused                   // Required for keyboard input
/>
```

**Select Events:**
| Event | Trigger | Use |
|-------|---------|-----|
| `onSelect` | Enter pressed | Confirm selection |
| `onChange` | Arrow keys | Preview/navigate |

### Hooks Reference

- `useRenderer()` - Access renderer for cleanup
- `useKeyboard(handler, options?)` - Keyboard events
- `usePaste(handler)` - Paste events
- `useTerminalDimensions()` - Reactive terminal size
- `useTimeline(options?)` - Animations

## Agents

| Agent | Mode | Tools | Purpose |
|-------|------|-------|---------|
| `build` | Primary | All | Main coding agent |
| `explore` | Subagent | Read-only (grep, glob, read) | Fast codebase search |
| `general` | Subagent | Most (no todo) | Complex multi-step tasks |

Agent-controlled delegation (no @ syntax for users).

## Session Header

Dynamic header line at the top of the session screen showing context about the current conversation/task. Similar to how ChatGPT/Claude/Gemini auto-generate chat titles.

### Format

```
[IMPULSE] | <context>
```

### Header States

| Scenario | Format | Example |
|----------|--------|---------|
| New session | `[IMPULSE] \| New session` | `[IMPULSE] \| New session` |
| AI sets context | `[IMPULSE] \| <description>` | `[IMPULSE] \| Express mode permission system` |
| After `/compact` | `[IMPULSE] \| Compacted: <description>` | `[IMPULSE] \| Compacted: Express mode` |
| After `/undo` | `[IMPULSE] \| Reverted: <description>` | `[IMPULSE] \| Reverted: Express mode` |
| After `/redo` | `[IMPULSE] \| Reapplied: <description>` | `[IMPULSE] \| Reapplied: Express mode` |
| After `/load` | Restore saved header | `[IMPULSE] \| Express mode permission system` |

### Tool: `set_header`

AI uses the `set_header` tool to update the header. Guidelines:
- Set at meaningful milestones (initial understanding, phase changes)
- Do NOT update constantly
- Keep titles concise (max 50 characters)
- Let the description naturally indicate the action

### Persistence

- Header title persists with session on `/save`
- Restored when session is loaded via `/load`
- Prefixes (Compacted/Reverted/Reapplied) are cleared on next AI update

## Todo System

Session-scoped task management for tracking complex, multi-step work.

### Data Model

```typescript
interface Todo {
  id: string        // Unique identifier
  content: string   // Brief task description
  status: string    // pending | in_progress | completed | cancelled
  priority: string  // high | medium | low
}
```

### Tools

| Tool | Purpose |
|------|---------|
| `TodoWrite` | Replace entire todo list (full replacement) |
| `TodoRead` | Read current session todos |

### UI Display

Todos appear in the sidebar panel:
- `[ ]` = pending (muted)
- `[>]` = in_progress (cyan)
- `[x]` = completed (muted)

Section collapses when >2 items, hides when all completed.

### Agent Usage

- Use for tasks with 3+ steps
- Only ONE todo `in_progress` at a time
- Mark complete IMMEDIATELY after finishing
- Don't use for trivial single-step tasks

## Question Tool

Interactive question tool for structured user input. Displays questions as navigable tabs with options and a review screen before submission.

### Schema

```typescript
interface Question {
  topic: string;              // Tab name (max 20 chars, e.g. "Platform", "UI stack")
  question: string;           // Full question text
  options: {
    label: string;            // 1-5 words
    description: string;      // Explanation
  }[];
  multiple?: boolean;         // Multi-select (default: false)
}

// Tool input
interface QuestionToolInput {
  context?: string;           // Why clarification is needed (shown in header)
  questions: Question[];      // Max 3 topics per call
}

// Tool output
interface QuestionToolOutput {
  answers: string[][];        // Selected/typed answers per topic
}
```

### UI Mockup (Tab-Based Layout)

```
┌─ CLARIFYING: Setting up your project ────────────────────────────┐
│                                                                  │
│  [ Platform ✓ ] [ UI stack ] [ Database ]                        │
│                                                                  │
│  What UI framework approach do you prefer?                       │
│                                                                  │
│   [ ] [1] React-like ── Component-based, declarative             │
│   [x] [2] Immediate mode ── Redraw each frame                    │
│   [ ] [3] No preference ── You decide                            │
│   [ ] [0] Type your own answer                                   │
│                                                                  │
│  Tab: Next topic  ↑↓: Navigate  Enter: Select  Esc: Cancel       │
└──────────────────────────────────────────────────────────────────┘
```

### Review Screen

```
┌─ REVIEW ANSWERS ─────────────────────────────────────────────────┐
│                                                                  │
│  [1] Platform: What platforms do you need to support?            │
│  ┌───────────────────────────────────────────────────────────┐   │
│  │ macOS + Linux                                             │   │
│  └───────────────────────────────────────────────────────────┘   │
│                                                                  │
│  [2] UI stack: What UI framework approach do you prefer?         │
│  ┌───────────────────────────────────────────────────────────┐   │
│  │ Immediate mode_                                           │   │
│  └───────────────────────────────────────────────────────────┘   │
│                                                                  │
│  Tab: Next  ↑↓: Navigate  e: Edit  Enter: Submit  Esc: Back      │
└──────────────────────────────────────────────────────────────────┘
```

### Keyboard Shortcuts

| Key | Action |
|-----|--------|
| `Tab` | Next topic/field |
| `Shift+Tab` | Previous topic/field |
| `↑/↓` | Navigate options |
| `1-9` | Quick-select option |
| `0` | Select "Type your own answer" |
| `Enter` | Confirm and advance (or submit on review) |
| `e` | Edit topic (on review screen) |
| `Esc` | Cancel / go back |

### Agent Usage

- **ALWAYS** use for gathering user preferences (never plain text questions)
- Maximum **3 topics** per call - use follow-up calls for more
- Each topic needs a short name (max 20 chars)
- Users can always type a custom answer
- Set `context` to explain WHY you're asking
- Keep option labels concise (1-5 words)

## MCP Servers

5 MCP servers are configured (4 Z.AI + Context7):

| Server | Type | Tools |
|--------|------|-------|
| **Vision** | Local (stdio) | `ui_to_artifact`, `extract_text_from_screenshot`, `diagnose_error_screenshot`, `understand_technical_diagram`, `analyze_data_visualization`, `ui_diff_check`, `image_analysis`, `video_analysis` |
| **Web Search** | Remote (HTTP) | `webSearchPrime` |
| **Web Reader** | Remote (HTTP) | `webReader` |
| **Zread** | Remote (HTTP) | `search_doc`, `get_repo_structure`, `read_file` |
| **Context7** | Remote (HTTP) | `resolve-library-id`, `query-docs` |

**Note:** The agent discovers MCP tools on-demand using `/mcp-tools search <query>` rather than preloading all tool descriptions into context. This keeps the context window lean.

## Commands

| Command | Description |
|---------|-------------|
| `/new` | New session (prompt to save) |
| `/compact` | Manual AI summarization |
| `/save` | Save with AI-suggested name |
| `/load` | Session picker with preview |
| `/undo` | Git-based revert to checkpoint |
| `/redo` | Restore undone changes |
| `/model` | Switch GLM model |
| `/mode` | Switch mode (alt to Tab) |
| `/instruct` | Edit project instructions |
| `/config` | Basic settings overlay |
| `/stats` | Session statistics |
| `/help` | Categorized help overlay |
| `/think` | Toggle thinking mode |
| `/quit` | Exit with summary |
| `/exit` | Exit with summary |

## Keyboard Shortcuts

| Key | Action |
|-----|--------|
| `Tab` | Cycle modes |
| `Shift+Tab` | Cycle modes reverse |
| `Enter` | Submit / Select |
| `Shift+Enter` | Line break in input |
| `↑/↓` | Navigate / Scroll |
| `@` | File/directory autocomplete |
| `Esc` (2x) | Cancel / Stop operation |
| `Ctrl+C` (2x) | Exit with summary |
| `Ctrl+B` | Toggle sidebar |
| `Ctrl+M` | MCP status overlay |
| `Ctrl+P` | Command palette |

## Project Conventions

### Code Style
- TypeScript strict mode
- No `any` types
- Prefer functional components
- Use Zod for runtime validation

### Naming
- Files: kebab-case (`status-line.tsx`)
- Components: PascalCase (`StatusLine`)
- Functions: camelCase (`createSession`)
- Constants: UPPER_SNAKE_CASE (`MAX_RETRIES`)

### Commits
- Conventional commits format
- Commit after each discrete task
- No `git push` without explicit permission

### UI
- No emojis anywhere
- Brutalist aesthetic
- 16ms event batching for streaming
- 60fps target

### UI Change Protocol (CRITICAL)
**ALWAYS create an ASCII mockup before implementing any UI changes.**

When proposing or implementing UI modifications:
1. **Create a mockup first** - Show the intended layout using ASCII art
2. **Get approval** - Wait for user confirmation before implementing
3. **Reference the mockup** - Keep the mockup visible during implementation

Example mockup format:
```
┌─ COMPONENT NAME ────────────────────────────────────────────┐
│                                                             │
│  [Element description]                                      │
│  [Another element]                                          │
│                                                             │
│  ┌─ Nested Component ─────────────────────────────────────┐ │
│  │  Content here                                          │ │
│  └────────────────────────────────────────────────────────┘ │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

This ensures:
- User can visualize changes before code is written
- Prevents wasted effort on unwanted designs
- Documents UI decisions for future reference

### UI Implementation References (CRITICAL)
**ALWAYS consult these resources before implementing visual changes:**

1. **OpenTUI Skill** (`.opencode/skill/opentui/`)
   - Check `references/solid/` for SolidJS-specific patterns
   - Check `references/keyboard/` for navigation/selection patterns
   - Check `references/layout/` for layout and list patterns
   - Check `references/components/` for component examples

2. **Context7 MCP** - Query library documentation:
   ```
   /mcp-tools context7 resolve-library-id  # Find library ID
   /mcp-tools context7 query-docs          # Query docs
   ```

3. **Existing Codebase Patterns** - Check similar components:
   - `src/ui/components/Autocomplete.tsx` - List selection with highlighting
   - `src/ui/components/Overlay.tsx` - Command palette selection
   - `src/ui/components/InputArea.tsx` - Dropdown autocomplete

**Key OpenTUI Patterns:**
- Use `<box backgroundColor={...}>` for highlight backgrounds (not `style={}`)
- Use `<text fg={...}>` for text colors
- Use `<Show when={...}>` for conditional rendering, not ternaries in props
- Selection: Change `fg` color AND optionally `backgroundColor` on container

## Generated Documentation

| Document | Purpose | Generated |
|----------|---------|-----------|
| [docs/Requirements.md](docs/Requirements.md) | Functional and non-functional requirements | 01-19-2026 |
| [docs/Design.md](docs/Design.md) | Architecture and visual design system | 01-20-2026 |
| [docs/Tasks.md](docs/Tasks.md) | Implementation tasks (BMAD-method) | 01-20-2026 |

## Installed Skills

| Skill | Location | Purpose |
|-------|----------|---------|
| OpenTUI | `.opencode/skill/opentui/` | TUI development with Core, React, Solid reconcilers |
| Frontend Design | `.opencode/skills/frontend-design/` | Brutalist terminal UI design patterns |
| Agent Browser | `.opencode/skills/agent-browser/` | Browser automation for research |

## Known Gotchas

### OpenTUI Specifics
- Uses Yoga for flexbox layout (not CSS)
- Mouse events require explicit handlers
- Scrollbox needs `stickyScroll` for auto-scroll behavior
- Never call `process.exit()` - use `renderer.destroy()`
- Solid uses underscores: `<tab_select>`, `<ascii_font>`, `<line_number>`
- Text styling requires nested tags: `<strong>`, `<em>`, `<span fg="...">`

### GLM API Specifics
- Thinking mode enabled by default on GLM-4.7
- Must preserve `reasoning_content` in conversation history
- Coding Plan endpoint: `https://api.z.ai/api/coding/paas/v4/`
- No silent fallbacks - explicit error handling required
- **`tool_stream=true` required** for streaming tool call output (Z.AI-specific parameter)
- **Tool arguments may contain `null`** for optional fields - must strip before Zod validation
  - Z.AI models send `{"timeout": null}` for omitted optional params
  - Zod `.optional()` means "can be omitted" but rejects `null` values
  - Use `stripNullValues()` helper before `schema.parse()`
- **Preserved Thinking** - Include `reasoning_content` in all assistant messages sent back to API
  - Improves model performance and cache hit rates (saves tokens/money)
  - Send `thinking: { type: "enabled", clear_thinking: false }` to enable
  - Must return reasoning_content exactly as received - don't modify or reorder
- **Interleaved Thinking** - Include reasoning with tool call messages
  - When assistant makes tool calls, include reasoning_content in that message
  - Helps model reason about tool results in context
- **Cache Tracking** - Extract `prompt_tokens_details.cached_tokens` from usage
  - Shows actual tokens served from cache (billed at ~50% discount)
  - Available in final streaming chunk's usage object
- **API Message Format for Tool Calls** - Conversation history must include tool_calls and tool results
  - After tool execution, don't just send back-to-back assistant messages
  - Correct format: `assistant (with tool_calls array)` -> `tool (results)` -> `assistant (continuation)`
  - Use `buildAPIMessages()` helper in App.tsx to properly serialize conversation history
  - Tool results use `role: "tool"` with `tool_call_id` matching the original call

### Streaming
- Use 16ms event batching to prevent flicker
- `batch()` from solid-js for coalesced updates
- `reconcile()` for efficient deep state updates
- **Tool call arguments arrive in first chunk** - `tool_call_start` event must include initial arguments
  - First chunk has `{id, function.name, function.arguments}` all together
  - Don't initialize `arguments: ""` and only accumulate from deltas - you'll lose the opening `{"`

### Configuration
- tsconfig.json needs `jsx: "preserve"` and `jsxImportSource: "@opentui/solid"`
- bunfig.toml needs `preload = ["@opentui/solid/preload"]`
- Use `@opentui/core` not platform-specific packages

## Decision Log

| Date | Decision | Rationale |
|------|----------|-----------|
| 01-19-2026 | Use OpenTUI + SolidJS | Flicker-free rendering, Zig-powered performance |
| 01-19-2026 | Single API key for all MCPs | Simplified configuration, better UX |
| 01-19-2026 | Tab for mode switching | Discoverable, matches user mental model |
| 01-19-2026 | Brutalist design | Function over form, terminal-native aesthetic |
| 01-19-2026 | No @ syntax for subagents | Agent controls delegation, simpler UX |
| 01-19-2026 | 70% auto-compact threshold | Balance between context preservation and limits |
| 01-19-2026 | Double-press safety (Esc, Ctrl+C) | Prevent accidental interruption/exit |
| 01-20-2026 | Install OpenTUI skill | Comprehensive reference for TUI development |
| 01-20-2026 | Install frontend-design skill | Brutalist visual design patterns |
| 01-20-2026 | Add Welcome Screen | First impression, shows key info at startup |
| 01-20-2026 | Enhanced Status Line | Progress bar, git branch, current tool activity |
| 01-20-2026 | Session End Summary | Clean exit with useful stats |
| 01-20-2026 | Design constants file | Single source of truth for colors/indicators |
| 01-20-2026 | Phase 2 UI components | Complete OpenTUI component set for core functionality |
| 01-20-2026 | Context providers | Mode, Session, Todo contexts for state management |
| 01-20-2026 | Global keyboard handler | Tab mode cycling, Ctrl+P/M commands, double-press safety |
| 01-20-2026 | MCP Manager pattern | Single manager class with unified initialization for all 4 MCPs |
| 01-20-2026 | MCP overlay integration | Reuse existing Overlay component for MCP status display |
| 01-20-2026 | Paste detection | Timing-based multi-line paste detection with line count indicator |
| 01-20-2026 | @ reference parser | Fuzzy filename matching, @~ expansion, line range support |
| 01-20-2026 | Input history navigation | Up/down arrow for browsing previous submissions |
| 01-20-2026 | Autocomplete dropdown | Positioned @ reference completion with keyboard navigation |
| 01-21-2026 | MCP auto-discovery | Agent automatically searches MCP tools when task requires external capabilities |
| 01-21-2026 | Hardcoded initial MCPs | Z.AI servers + Context7 as MVP, registry integration later |
| 01-21-2026 | Strip null from tool args | Z.AI sends null for optional fields, Zod rejects null - strip before validation |
| 01-21-2026 | Use signals for abort refs | `let` variables in keyboard handlers capture stale closures - use SolidJS signals |
| 01-21-2026 | Lift autocomplete to App.tsx | Overlays need root-level rendering for proper z-index stacking |
| 01-21-2026 | Collapsible thinking section | Click-to-expand with 5-row scroll height, reduces visual noise |
| 01-21-2026 | exitPending signal pattern | Avoid `window` object in Node/Bun - use signals for cross-component state |
| 01-22-2026 | Inner padding as buffer | 2-char padding in ChatView prevents content from pushing borders |
| 01-22-2026 | Height calculation constants | BottomPanel uses named constants (TEXTAREA_HEIGHT, BORDER_HEIGHT, PADDING_HEIGHT) |
| 01-22-2026 | ThinkingBlock 2-row preview | Collapsed=2 rows auto-scroll, Expanded=8 rows manual scroll, click to toggle |
| 01-22-2026 | Explicit dimensions at root | Use `dimensions().width/height` not "100%" strings - Yoga handles numbers more reliably |
| 01-22-2026 | Unified left gutter layout | Eliminates right scrollbar (was pushing content), gutter shows scroll + spinner |
| 01-22-2026 | InputArea borderless design | Mode-colored accent lines instead of border, footer shows mode/model |
| 01-23-2026 | Multi-platform npm distribution | OpenCode-style binary packages per platform with wrapper CLI |
| 01-23-2026 | chmod +x in CI/CD | Bun compile doesn't set execute bit - must chmod after build |
| 01-23-2026 | chmod in postinstall | npm tarballs strip execute bits - must chmod in postinstall.mjs |
| 01-23-2026 | --no-compile-autoload-bunfig | Compiled binaries must not load bunfig.toml - JSX already transformed |
| 01-23-2026 | Inline tool descriptions | External .txt files can't be embedded in compiled binary - inline in TypeScript |
| 01-23-2026 | Windows ARM64 not supported | Bun doesn't have cross-compile target yet - will add when available |
| 01-23-2026 | CLI args before TUI | Parse --help/--version before TUI init so they work without API key or TTY |
| 01-23-2026 | TTY detection | Fail fast with clear message if not running in interactive terminal |
| 01-23-2026 | First-run banner | Print plain-text message before TUI when no API key configured |
| 01-23-2026 | Z.AI Preserved Thinking | Include reasoning_content in API messages per Z.AI docs - improves cache hit rates |
| 01-23-2026 | Z.AI Thinking Config | Send thinking parameter with type/clear_thinking per Z.AI docs - enables toggle |
| 01-23-2026 | Z.AI Cache Tracking | Extract cached_tokens from prompt_tokens_details - shows actual savings |
| 01-23-2026 | Interleaved Thinking | Include reasoning in tool continuation messages per Z.AI docs |
| 01-25-2026 | buildAPIMessages helper | Fix duplicate assistant messages - properly serialize tool_calls and tool results in conversation history |

## Future Work

### MCP Registry Integration (Planned)

**Goal:** Allow users to search and install MCP servers from the official registry.

**Registry URL:** https://registry.modelcontextprotocol.io/

**Planned UX:**
1. User types `/mcp` and searches for a capability (e.g., "github", "slack", "database")
2. System queries the MCP registry for matching servers
3. User selects a server to install
4. Server is added to local config and initialized

**Why Later:**
- MVP focuses on hardcoded Z.AI + Context7 servers
- Registry integration requires OAuth flows for many servers
- Need to design secure credential storage first

**Technical Notes:**
- Registry API provides server metadata, auth requirements, tool lists
- Some servers require OAuth, others just API keys
- Consider mcp-launchpad patterns for auth handling

### Tool Display Refactor (COMPLETE)

**Status:** Implemented in v0.15.x - v0.18.x releases

**Key Features Delivered:**
- Collapsible tool blocks (click to expand/collapse)
- Status indicators: ✓ (success), ✗ (error), ~ (running)
- Bash: Show first 3 lines of output, expandable
- File edits: Unified diff view with +/- markers
- File writes: Filename + line count
- Auto-expand failed tools for visibility

**Implementation Files:**
- `src/ui/components/CollapsibleToolBlock.tsx` - Collapse/expand logic
- `src/ui/components/DiffView.tsx` - Unified diff renderer
- `src/types/tool-metadata.ts` - Tool metadata types
- `src/ui/components/MessageBlock.tsx` - Integration point

**Archived Documentation:** [docs/archive/feature-tool-display/](docs/archive/feature-tool-display/)

## How to Run

```bash
# Install dependencies
bun install

# Run in development mode
bun run dev

# Build for production
bun run build

# Run production build
bun run start
```

## How to Test

```bash
# Run all tests
bun test

# Run tests in watch mode
bun test --watch

# Run specific test file
bun test src/path/to/test.ts
```

## How to Debug

### Verbose Mode (`--verbose`)

Run with `--verbose` flag to enable debug logging:

```bash
# Development
bun run start -- --verbose

# Production binary
impulse --verbose
```

**Log Location:** `~/.config/impulse/debug/session-<timestamp>.jsonl`

**What Gets Logged:**
- `session_start` - Version and timestamp
- `user_message` - Full user input
- `api_request` - Model, message count, content previews, tool count
- `raw_api_messages` - Full API message array (for debugging conversation format)
- `tool_execution` - Tool name, arguments, success/failure, output
- `error` - Context and error details

**Use Cases:**
- Debugging API message serialization (tool_calls, tool results)
- Verifying conversation history is correctly formatted
- Tracking tool execution flow
- Diagnosing MCP tool failures

**Performance Impact:** None when `--verbose` is not passed. All log functions check `debugEnabled` first and return immediately if false.

**Example Log Entry:**
```json
{"type":"api_request","timestamp":"2026-01-25T01:58:31.331Z","model":"glm-4.7","messageCount":5,"messages":[{"role":"system","contentLength":6735},{"role":"user","contentLength":240},{"role":"assistant","contentLength":112},{"role":"tool","contentLength":45},{"role":"assistant","contentLength":1831}],"toolCount":27}
```

## CI/CD Pipeline

### Overview

IMPULSE uses GitHub Actions for automated builds and npm publishing. The pipeline builds standalone binaries for 6 platform/architecture combinations and publishes them as scoped npm packages.

### Workflow: `.github/workflows/release.yml`

**Triggers:**
- Push to tags matching `v*` (e.g., `v0.15.6`)
- Manual workflow dispatch with version input

### Build Matrix

| Platform | Architecture | Runner | Build Method | Package |
|----------|--------------|--------|--------------|---------|
| Linux | x64 | `ubuntu-latest` | Native | `@spenceriam/impulse-linux-x64` |
| Linux | ARM64 | `ubuntu-24.04-arm` | Native | `@spenceriam/impulse-linux-arm64` |
| macOS | ARM64 | `macos-latest` | Native | `@spenceriam/impulse-darwin-arm64` |
| macOS | x64 | `macos-15-intel` | Native | `@spenceriam/impulse-darwin-x64` |
| Windows | x64 | `windows-latest` | Native | `@spenceriam/impulse-windows-x64` |

**Note:** Windows ARM64 is not currently supported. Bun doesn't have a cross-compile target for Windows ARM64 yet (`bun-windows-aarch64` returns "Unsupported compile target"). Will be added when Bun supports it.

### Build Process

1. **Build dist** - `bun run build` transforms TypeScript/JSX to JavaScript via `scripts/build.ts`
2. **Compile binary** - `bun build --compile --minify --no-compile-autoload-bunfig --target=<target>` creates standalone executable
3. **Package** - Each binary is packaged with its own `package.json` specifying `os` and `cpu` fields

### Key Flags

- `--no-compile-autoload-bunfig`: Prevents compiled binary from loading `bunfig.toml` at runtime (JSX already transformed)
- `--minify`: Reduces binary size
- `--target=<target>`: Specifies build target (enables cross-compilation)

### Publishing

1. Platform packages published first (6 packages)
2. CLI wrapper package (`@spenceriam/impulse`) published last with `optionalDependencies` pointing to all platform packages
3. npm's `optionalDependencies` automatically installs only the matching platform package

### Wrapper Package Structure

```
@spenceriam/impulse/
├── bin/impulse           # Node.js wrapper script (Unix)
├── bin/impulse.cmd       # Batch wrapper script (Windows) 
├── postinstall.mjs       # Symlinks correct platform binary
└── package.json          # Lists all platform packages as optionalDependencies
```

### postinstall.mjs Behavior

1. Detects platform (`darwin`/`linux`/`windows`) and architecture (`x64`/`arm64`)
2. Finds the matching platform package (e.g., `@spenceriam/impulse-linux-x64`)
3. Sets execute permission (`chmod +x`) on the binary (npm tarballs strip this)
4. Creates symlink from `bin/impulse` to the platform binary
5. On Windows: Uses the binary directly (no symlink needed)

### Release Workflow

```bash
# 1. Update version
npm version patch  # or minor/major

# 2. Update CHANGELOG.md
# 3. Commit changes
git add -A && git commit -m "fix/feat: description"

# 4. Create and push tag
git tag -a v0.X.Y -m "Release v0.X.Y"
git push origin main
git push origin v0.X.Y

# 5. Monitor workflow
gh run watch
```

### Secrets Required

- `NPM_TOKEN`: npm automation token with publish access to `@spenceriam` scope

### Test Devices

| Platform | Device | Notes |
|----------|--------|-------|
| macOS ARM64 | Apple Silicon Mac | CI tested |
| Linux ARM64 | ARM64 runner | CI tested |

## Project Structure

```
impulse/
├── .opencode/
│   ├── skill/opentui/       # OpenTUI skill references
│   ├── skills/              # Other skills (frontend-design, etc.)
│   └── command/             # Slash commands
├── docs/                    # Project documentation
├── src/
│   ├── index.tsx           # CLI entry point
│   ├── global.ts           # Global paths configuration
│   ├── agent/              # GLM agent and subagents
│   ├── api/                # Z.AI API client
│   ├── bus/                # Event bus
│   ├── mcp/                # MCP server integrations
│   ├── session/            # Session management
│   ├── storage/            # File-based storage
│   ├── tools/              # Built-in tools
│   ├── ui/                 # OpenTUI components
│   │   ├── components/     # Reusable UI components
│   │   │   ├── ProgressBar.tsx
│   │   │   ├── StatusLine.tsx
│   │   │   ├── InputArea.tsx
│   │   │   ├── ChatView.tsx
│   │   │   ├── MessageBlock.tsx
│   │   │   ├── ThinkingBlock.tsx
│   │   │   ├── ToolBlock.tsx
│   │   │   ├── Sidebar.tsx
│   │   │   ├── TodoItem.tsx
│   │   │   └── Overlay.tsx
│   │   ├── context/        # SolidJS contexts
│   │   │   ├── mode.tsx
│   │   │   ├── session.tsx
│   │   │   └── todo.tsx
│   │   └── design.ts       # Design constants (colors, indicators)
│   ├── input/              # Input handling (paste, @refs)
│   │   ├── shortcuts.ts     # Global keyboard handler
│   │   └── index.ts
│   ├── commands/           # Slash commands
│   ├── modes/              # Mode-specific logic
│   └── util/               # Utilities
├── AGENTS.md               # This file (project brain)
├── PRINCIPLES.md           # Non-negotiable rules
├── README.md               # Project overview
├── package.json
├── tsconfig.json
└── bunfig.toml
```

## Instruction File Discovery

impulse checks for project instructions in this order:

1. `.impulse/instructions.md`
2. `AGENTS.md`
3. `CLAUDE.md`
4. `GEMINI.md`
5. `QWEN.md`
6. `KIMI.md`
7. `COPILOT.md`
8. `.cursorrules`
9. `.windsurfrules`
